#!/usr/bin/env bb

(ns commit-msg.main
  (:require [clojure.data.json :as json]
            [babashka.cli      :as cli]
            [babashka.process  :refer [shell process exec]]))



(defn display-with-shell
  "Displays 'lines' using the 'shell' command, which supports color coding.  Argument 'lines' may be a string or a vector of strings."
  [lines]
  (if (= (.getSimpleName (type lines)) "String")
    (display-with-shell [lines])
    (dorun (map shell (map #(str "echo -e " %) lines)))))


(defn display-with-shell-newline
  "Displays newlines.  Displays one newline without arguments or int 'num' newlines."
  ([]
  (display-with-shell-newline 1))
  ([num]
  (display-with-shell (vec (repeat num "\n")))))


(defn display-err-msg
  "Displays the error message string 'err-msg', using color-coding from the shell"
  [err-msg]
  (display-with-shell
   ["\\e[1m\\e[31m[COMMIT REJECTED (local)]"
    "\\e[0m\\e[1mCommit failed: " err-msg]))


(defn display-warn-msg
  "Displays the warning message string 'warn-msg' and notes that the commit is proceeding.  Uses color-coding from the shell."
  [warn-msg]
  (display-with-shell (str "\\e[34mWARNING (local): " warn-msg "  Commit proceeding.\033[0m\\e[0m")))


;;todo finish
(defn display-err-commit-msg
  "Displays the commit message string 'msg' and, if the optional int 'line-num' is set, notes the line number in error and highlights that line in the commit message.  Uses color-coding from the shell."
  ([msg]
   (display-commit-msg msg -1))
  ([msg line-num]
   (let [lines
         ["\\e[34m**********************************************"
          "BEGIN - COMMIT MESSAGE ***********************"
          "**********************************************\\033[0m\\e[0m"
          "\\e[34m**********************************************"
          "END - COMMIT MESSAGE *************************"
          "**********************************************\\033[0m\\e[0m"]])
   (println line-num)))


(defn exit
  [value]
  (System/exit value))


(defn handle-err-exit
  ([err-msg]
   (println "err" err-msg))
  ([err-msg commit-msg]
   (println "commit" err-msg commit-msg))
  ([err-msg commit-msg line-num]
   (println "commit line" err-msg commit-msg line-num)))


(defn handle-warn-proceed
  [warn-msg]
  (display-warn-msg warn-msg))


(defn get-commit-msg
  [filename]
  (slurp filename))


;; start
;;todo
(let [args *command-line-args*]
  (if (= (count args) 1)
    (dostuff (first args))
    (err and exit)))


;;(let [commit-msg-cfg "commit-msg.cfg.json"])
;;(".git/COMMIT_EDITMSG")

(display-err-msg "err!")
(display-with-shell-newline)
(display-with-shell-newline 3)
(display-warn-msg "warned!")

;;to do
(println (get-commit-msg))
